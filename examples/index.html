<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>分片上传案例</title>
    <link rel="stylesheet" href="http://zui.sexy/dist/css/zui.min.css" rel="external nofollow">
</head>

<body>
    <div class="container" style="margin-top: 30px;">
        <form class="form-inline" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <input type="file" id="fileBig" class="form-control">
            </div>
            <button type="button" class="btn btn-primary">提交</button>
        </form>
    </div>
  
    <script src="http://zui.sexy/assets/jquery.js"></script>
    <script src="http://zui.sexy/dist/js/zui.min.js"></script>
    
    <script type="text/javascript">

        $('.btn-primary').click(function () 
        {
            // 文件详情
            let file = $("#fileBig")[0].files[0];
            let fileName = file.name;
            let fileSize = file.size;


            let blockSize = 0.9 * 1024 * 1024;
            let totalNum = Math.ceil(fileSize / blockSize);
            let start = 0;
            let end = 0;

            for (let i = 1; i <= totalNum; i++) 
            {
                end = blockSize * i;

                if (end > fileSize) 
                {
                    end = fileSize;
                }

                let block = file.slice(start, end);
                start = end;
                let fd = new FormData();

                fd.append('file', block);
                fd.append('name', fileName);
                fd.append('num', i);
                fd.append('total_num', totalNum);
                
                $.ajax({
                    url: "/test.php",
                    type: "POST",
                    data: fd,
                    async: false, // 此处同步上传，保证顺序
                    processData: false,
                    contentType: false,
                    success: (res) => {
                        console.log('res_' + i + ": " + res);
                    }
                })
            }
        });
    </script>
</body>

</html>